version: "3.9"

services:
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: korjournal-api
    restart: unless-stopped
    environment:
      # --- Databas (extern MariaDB på NAS) ---
      DATABASE_URL: "mysql+pymysql://${NAS_DB_USER:?set NAS_DB_USER}:${NAS_DB_PASS:?set NAS_DB_PASS}@${NAS_DB_HOST:?set NAS_DB_HOST}:${NAS_DB_PORT:-3306}/${NAS_DB_NAME:?set NAS_DB_NAME}?charset=utf8mb4"

      # --- CORS: tillåt web-UI från din server + localhost ---
      CORS_ORIGINS: "http://${SERVER_HOST:?set SERVER_HOST}:${WEB_PORT:-3001},http://localhost:${WEB_PORT:-3001}"

      # --- Home Assistant (obligatoriskt) ---
      HA_BASE_URL: ${HA_BASE_URL:?set HA_BASE_URL}
      HA_TOKEN: ${HA_TOKEN:?set HA_TOKEN}
      HA_ODOMETER_ENTITY: ${HA_ODOMETER_ENTITY:?set HA_ODOMETER_ENTITY}
      HA_FORCE_DOMAIN: ${HA_FORCE_DOMAIN:-kia_uvo}
      HA_FORCE_SERVICE: ${HA_FORCE_SERVICE:-force_update}
      # Default JSON om inget satt i .env (måste vara citerat pga YAML)
      HA_FORCE_DATA: "${HA_FORCE_DATA:-{\"entity_id\":\"sensor.kia_uvo_odometer\"}}"

      # --- (valfritt) OSRM för ruttbaserad sträcka ---
      # OSRM_URL: ${OSRM_URL}
    ports:
      - "${API_PORT:-8080}:8080"
    healthcheck:
      test: [["CMD-SHELL", "curl -fsS http://localhost:8080/health >/dev/null || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  web:
    build:
      context: ./web
    container_name: korjournal-web
    restart: unless-stopped
    environment:
      # Peka webben mot API:t via serverns publika adress
      NEXT_PUBLIC_API_URL: "http://${SERVER_HOST:?set SERVER_HOST}:${API_PORT:-8080}"
      # NODE_ENV: production
    ports:
      - "${WEB_PORT:-3001}:3000"
    depends_on:
      api:
        condition: service_healthy
